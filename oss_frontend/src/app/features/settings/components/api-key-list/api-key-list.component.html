<div class="api-key-list-container">
  <div class="header">
    <h2>{{ 'settings.apiKeys.title' | translate }}</h2>
    <button class="btn btn-primary" (click)="createApiKey()">
      <i class="fas fa-plus"></i> {{ 'settings.apiKeys.create' | translate }}
    </button>
  </div>

  @if (loading) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>{{ 'common.loading' | translate }}</p>
    </div>
  }

  @if (error) {
    <div class="alert alert-danger">
      {{ error }}
    </div>
  }

  @if (!loading && apiKeys.length === 0) {
    <div class="empty-state">
      <p>{{ 'settings.apiKeys.noKeys' | translate }}</p>
    </div>
  }

  @if (!loading && apiKeys.length > 0) {
    <div class="api-keys-table-container">
      <table class="api-keys-table">
        <thead>
        <tr>
          <th>{{ 'settings.apiKeys.name' | translate }}</th>
          <th>{{ 'settings.apiKeys.expiresAt' | translate }}</th>
          <th>{{ 'settings.apiKeys.daysUntilExpiry' | translate }}</th>
          <th>{{ 'settings.apiKeys.status' | translate }}</th>
          <th>{{ 'settings.apiKeys.createdBy' | translate }}</th>
          <th>{{ 'settings.apiKeys.createdAt' | translate }}</th>
          <th>{{ 'common.actions' | translate }}</th>
        </tr>
        </thead>
        <tbody>
          @for (apiKey of apiKeys; track apiKey.id) {
            <tr>
              <td>{{ apiKey.name }}</td>
              <td>{{ apiKey.expires_at | date:'medium' }}</td>
              <td>
                <span class="days-badge" [class.expired]="apiKey.is_expired" [class.warning]="apiKey.days_until_expiry <= 30 && !apiKey.is_expired">
                  {{ apiKey.days_until_expiry }} {{ 'settings.apiKeys.days' | translate }}
                </span>
              </td>
              <td>
                <span class="status-badge" [class.active]="apiKey.is_active && !apiKey.is_expired" [class.inactive]="!apiKey.is_active || apiKey.is_expired">
                  @if (apiKey.is_expired) {
                    {{ 'settings.apiKeys.expired' | translate }}
                  } @else if (apiKey.is_active) {
                    {{ 'common.active' | translate }}
                  } @else {
                    {{ 'common.inactive' | translate }}
                  }
                </span>
              </td>
              <td>{{ apiKey.created_by_email || ('common.unknown' | translate) }}</td>
              <td>{{ apiKey.created_at | date:'medium' }}</td>
              <td class="actions">
                <button class="btn btn-sm btn-info" (click)="viewApiKey(apiKey)" title="View API Key">
                  <i class="fas fa-eye"></i> View
                </button>
                @if (apiKey.is_active && !apiKey.is_expired) {
                  <button class="btn btn-sm btn-warning" (click)="revokeApiKey(apiKey)" title="{{ 'settings.apiKeys.revoke' | translate }}">
                    <i class="fas fa-ban"></i> {{ 'settings.apiKeys.revoke' | translate }}
                  </button>
                } @else if (!apiKey.is_active && !apiKey.is_expired) {
                  <button class="btn btn-sm btn-info" (click)="activateApiKey(apiKey)" title="{{ 'settings.apiKeys.activate' | translate }}">
                    <i class="fas fa-check"></i> {{ 'settings.apiKeys.activate' | translate }}
                  </button>
                }
                <button class="btn btn-sm btn-danger" (click)="deleteApiKey(apiKey)" title="{{ 'common.delete' | translate }}">
                  <i class="fas fa-trash"></i> {{ 'common.delete' | translate }}
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>

      @if (totalPages > 1) {
        <div class="pagination">
          <button
            class="btn btn-outline-primary"
            [disabled]="currentPage === 1"
            (click)="onPageChange(currentPage - 1)"
          >
            <i class="fas fa-chevron-left"></i> {{ 'common.previous' | translate }}
          </button>
          <span class="page-info">{{ 'common.page' | translate }} {{ currentPage }} {{ 'common.of' | translate }} {{ totalPages }}</span>
          <button
            class="btn btn-outline-primary"
            [disabled]="currentPage === totalPages"
            (click)="onPageChange(currentPage + 1)"
          >
            {{ 'common.next' | translate }} <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      }
    </div>
  }
</div>

<!-- API Key View Modal -->
@if (selectedApiKey) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ selectedApiKey.name }}</h3>
        <button class="modal-close" (click)="closeModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="api-key-display">
          <label class="field-label">{{ 'settings.apiKeys.key' | translate }}</label>
          <div class="key-container">
            <code class="api-key-value">{{ selectedApiKey.key }}</code>
            <button class="btn-copy" (click)="copyToClipboard(selectedApiKey.key)" [class.copied]="copied">
              <i class="fas" [class.fa-copy]="!copied" [class.fa-check]="copied"></i>
              <span>{{ copied ? 'Copied!' : 'Copy' }}</span>
            </button>
          </div>
        </div>
        <div class="api-key-info">
          <div class="info-row">
            <span class="info-label">{{ 'settings.apiKeys.expiresAt' | translate }}:</span>
            <span class="info-value">{{ selectedApiKey.expires_at | date:'medium' }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">{{ 'settings.apiKeys.daysUntilExpiry' | translate }}:</span>
            <span class="info-value">
              <span class="days-badge" [class.expired]="selectedApiKey.is_expired" [class.warning]="selectedApiKey.days_until_expiry <= 30 && !selectedApiKey.is_expired">
                {{ selectedApiKey.days_until_expiry }} {{ 'settings.apiKeys.days' | translate }}
              </span>
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">{{ 'settings.apiKeys.status' | translate }}:</span>
            <span class="info-value">
              <span class="status-badge" [class.active]="selectedApiKey.is_active && !selectedApiKey.is_expired" [class.inactive]="!selectedApiKey.is_active || selectedApiKey.is_expired">
                @if (selectedApiKey.is_expired) {
                  {{ 'settings.apiKeys.expired' | translate }}
                } @else if (selectedApiKey.is_active) {
                  {{ 'common.active' | translate }}
                } @else {
                  {{ 'common.inactive' | translate }}
                }
              </span>
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">{{ 'settings.apiKeys.createdBy' | translate }}:</span>
            <span class="info-value">{{ selectedApiKey.created_by_email || ('common.unknown' | translate) }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">{{ 'settings.apiKeys.createdAt' | translate }}:</span>
            <span class="info-value">{{ selectedApiKey.created_at | date:'medium' }}</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" (click)="closeModal()">Close</button>
      </div>
    </div>
  </div>
}

